
WebWaka Core Permissions (webwaka-core-permissions)

Execution Platform
	â€¢	Platform: Replit
	â€¢	Account: Replit-02
	â€¢	GitHub Org: ChangerPlanet
	â€¢	Repository: changerplanet/webwaka-core-permissions
	â€¢	Branch Strategy:
	â€¢	Clone â†’ implement â†’ push directly to main
	â€¢	No feature branches required

â¸»

ğŸ”’ NON-NEGOTIABLE PRECONDITIONS (MUST ACKNOWLEDGE)

Before writing any code, you must confirm the following in your response:
	1.	You will clone the repository from GitHub first:

https://github.com/changerplanet/webwaka-core-permissions


	2.	This is a TypeScript-only library module
	â€¢	âŒ No React
	â€¢	âŒ No FastAPI
	â€¢	âŒ No HTTP server
	â€¢	âŒ No UI
	3.	Casbin is the only authorized OSS engine
	4.	The module:
	â€¢	Has no authentication logic
	â€¢	Receives (tenantId, userId) from webwaka-core-identity
	5.	You will push directly to main when complete

If any of the above is unclear â†’ STOP and ask.

â¸»

ğŸ¯ OBJECTIVE

Implement the canonical authorization engine for WebWaka using Casbin, providing:
	â€¢	Tenant-isolated RBAC
	â€¢	Capability-based permissions
	â€¢	Deterministic & auditable decisions
	â€¢	Headless, reusable logic for all Suites

â¸»

ğŸ“¦ SCOPE (STRICT)

You MUST implement:

1. Core Permissions Service

Create PermissionsService exposing:

checkPermission(input: {
  tenantId: string
  userId: string
  capability: string
}): Promise<{
  allowed: boolean
  grantedBy: string[]   // roles or policies
}>

checkPermissions(
  tenantId: string,
  userId: string,
  capabilities: string[]
)

checkAnyPermission(
  tenantId: string,
  userId: string,
  capabilities: string[]
)


â¸»

2. Role & Assignment Management

createRole()
getRole()
updateRole()
deleteRole()
listRoles()

assignRole()
removeRole()
getUserRoles()
getUserCapabilities()

All scoped strictly by tenantId.

â¸»

3. Casbin Integration (MANDATORY)
	â€¢	Use Casbin as the policy engine
	â€¢	Configure Casbin with:
	â€¢	subject = userId
	â€¢	domain = tenantId
	â€¢	action = capability
	â€¢	Support:
	â€¢	Role â†’ capability mapping
	â€¢	User â†’ role assignment
	â€¢	Domain-aware enforcement

â¸»

4. Storage Abstractions

Define interfaces only:
	â€¢	RoleStorage
	â€¢	UserRoleStorage
	â€¢	PolicyStorage

Provide:
	â€¢	In-memory implementations for tests only

âš ï¸ No database assumptions.

â¸»

5. Deterministic & Auditable Output

Every permission check must return:
	â€¢	allowed: boolean
	â€¢	grantedBy: string[] (roles or policies responsible)

No silent allow/deny.

â¸»

ğŸ§ª TESTING REQUIREMENTS

You MUST implement:
	â€¢	Jest test suite
	â€¢	Tests for:
	â€¢	Tenant isolation
	â€¢	Cross-tenant denial
	â€¢	Role assignment
	â€¢	Capability resolution
	â€¢	Deterministic outcomes
	â€¢	Minimum coverage: 80%
	â€¢	Tests proving the hard stop condition

â¸»

ğŸ›‘ HARD STOP CONDITION (MANDATORY)

You must stop immediately once this is true:

Any Suite can ask:
â€œCan user X (tenant Y) perform capability Z?â€

And receive a deterministic, auditable answer explaining:
	â€¢	Allowed or denied
	â€¢	Why
	â€¢	Which role/policy granted it

You must include a test named:

Suite can check capability and receive deterministic, auditable result


â¸»

ğŸš« EXPLICITLY FORBIDDEN
	â€¢	âŒ Authentication logic
	â€¢	âŒ Clerk usage
	â€¢	âŒ HTTP APIs
	â€¢	âŒ Suite-specific permissions
	â€¢	âŒ Implicit access rules
	â€¢	âŒ Hard-coded roles

â¸»

ğŸ“„ REQUIRED FILES

You must update or create:
	â€¢	src/permissions-service.ts
	â€¢	src/casbin-adapter.ts
	â€¢	src/storage.ts
	â€¢	src/types.ts
	â€¢	src/index.ts
	â€¢	module.manifest.json
	â€¢	module.contract.md
	â€¢	__tests__/*.test.ts

â¸»

ğŸ“Œ DEPENDENCIES
	â€¢	casbin (required)
	â€¢	zod (validation)
	â€¢	jest (tests)

â¸»

ğŸ§¾ COMPLETION REPORT (REQUIRED)

When finished, respond with only:
	1.	Completion Summary
	2.	Public APIs exposed
	3.	Hard stop proof
	4.	Test coverage numbers
	5.	Final commit SHA on main

Then STOP.

â¸»

ğŸš¦ DO NOT PROCEED PAST THIS STEP

No Phase 2 â€” Step 04 work is allowed until explicit authorization.

â¸»